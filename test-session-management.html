<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Test Session ID Management - GeekWay Chat v3.0.2</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 10px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
        .info { background: #d1ecf1; color: #0c5460; border-left: 4px solid #17a2b8; }
        .warning { background: #fff3cd; color: #856404; border-left: 4px solid #ffc107; }
        .error { background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; }
        .change { background: #e1f5fe; color: #01579b; border-left: 4px solid #0288d1; }
        h1 { color: #333; text-align: center; margin-bottom: 30px; }
        .behavior-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .behavior-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }
        .before-after {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .comparison-box {
            padding: 20px;
            border-radius: 8px;
            text-align: left;
            border: 2px solid;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .before { border-color: #ef4444; background: #fef2f2; color: #7f1d1d; }
        .after { border-color: #22c55e; background: #f0fdf4; color: #14532d; }
        .debug-box {
            background: #f1f5f9;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            border: 1px solid #e4e4e7;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        .test-button {
            padding: 10px 20px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        .test-button:hover {
            background: #2563eb;
        }
        .clear-button {
            background: #ef4444;
        }
        .clear-button:hover {
            background: #dc2626;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Test Session ID Management v3.0.2</h1>
        
        <div class="status change">
            <strong>üîÑ CORRECCI√ìN IMPLEMENTADA:</strong> Session ID ahora se env√≠a correctamente en BODY seg√∫n documentaci√≥n API
        </div>        <div class="before-after">
            <div class="comparison-box before">
                <strong>‚ùå ANTES (Incorrecto):</strong><br><br>
                POST Body:<br>
                {<br>
                &nbsp;&nbsp;"message": "Hola" // Solo mensaje<br>
                }<br><br>
                Headers:<br>
                {<br>
                &nbsp;&nbsp;"x-key": "api-key",<br>
                &nbsp;&nbsp;"session_id": "uuid" // ‚ùå En header<br>
                }
            </div>
            <div class="comparison-box after">
                <strong>‚úÖ DESPU√âS (Correcto):</strong><br><br>
                POST Body:<br>
                {<br>
                &nbsp;&nbsp;"message": "Hola",<br>
                &nbsp;&nbsp;"session_id": "uuid" // ‚úÖ En body<br>
                }<br><br>
                Headers:<br>
                {<br>
                &nbsp;&nbsp;"x-key": "api-key" // Solo x-key<br>
                }
            </div>
        </div>

        <div class="behavior-grid">
            <div class="behavior-item">
                <strong>üì® Primer Mensaje</strong><br>
                ‚Ä¢ Body: solo "message"<br>
                ‚Ä¢ Headers: solo "x-key"<br>
                ‚Ä¢ No session_id enviado
            </div>
            <div class="behavior-item">
                <strong>üì• Respuesta API</strong><br>
                ‚Ä¢ Contiene session_id en response.data<br>
                ‚Ä¢ Se guarda en localStorage<br>
                ‚Ä¢ Key: "session_id"
            </div>
            <div class="behavior-item">
                <strong>üì§ Mensajes Posteriores</strong><br>
                ‚Ä¢ Body: "message" + "session_id"<br>
                ‚Ä¢ Headers: solo "x-key"<br>
                ‚Ä¢ session_id desde localStorage
            </div>
            <div class="behavior-item">
                <strong>üíæ Persistencia</strong><br>
                ‚Ä¢ Guardado en localStorage<br>
                ‚Ä¢ Sobrevive refresh/reload<br>
                ‚Ä¢ Manual clear posible
            </div>
        </div>

        <div class="debug-box">
            <strong>üîç Session ID actual en localStorage:</strong><br>
            <span id="current-session">Verificando...</span>
        </div>

        <div class="button-group">
            <button class="test-button" onclick="checkSessionId()">üîç Verificar Session ID</button>
            <button class="test-button clear-button" onclick="clearSessionId()">üóëÔ∏è Limpiar Session ID</button>
            <button class="test-button" onclick="simulateFirstMessage()">üì® Simular Primer Mensaje</button>
            <button class="test-button" onclick="simulateSecondMessage()">üì§ Simular Segundo Mensaje</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        const results = document.getElementById('results');

        function addResult(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = message;
            results.appendChild(div);
        }

        function checkSessionId() {
            const sessionId = localStorage.getItem('session_id');
            const currentSpan = document.getElementById('current-session');

            if (sessionId) {
                currentSpan.textContent = sessionId;
                addResult(`‚úÖ Session ID encontrado: ${sessionId}`, 'success');
            } else {
                currentSpan.textContent = 'No existe';
                addResult('‚ÑπÔ∏è No hay Session ID en localStorage', 'info');
            }
        }

        function clearSessionId() {
            localStorage.removeItem('session_id');
            document.getElementById('current-session').textContent = 'No existe';
            addResult('üóëÔ∏è Session ID eliminado del localStorage', 'warning');
        }

        function simulateFirstMessage() {
            const sessionId = localStorage.getItem('session_id');

            const requestInfo = {
                method: 'POST',
                url: 'http://localhost:3000/api/v1/threads/chat',
                headers: {
                    'Content-Type': 'application/json',
                    'x-key': 'demo-api-key'
                },
                body: {
                    message: 'Hola, este es mi primer mensaje'
                }
            };

            // Si no hay session_id, es realmente el primer mensaje
            if (!sessionId) {
                addResult('üì® PRIMER MENSAJE simulado - Solo mensaje en body, sin session_id', 'info');
            } else {
                addResult('‚ö†Ô∏è Ya existe session_id, este NO ser√≠a el primer mensaje', 'warning');
                requestInfo.headers['session_id'] = sessionId;
            }

            addResult(`<pre>${JSON.stringify(requestInfo, null, 2)}</pre>`, 'info');
        }

        function simulateSecondMessage() {
            const sessionId = localStorage.getItem('session_id');
            
            if (!sessionId) {
                addResult('‚ùå No hay session_id. Primero simula una respuesta de API o limpia y recarga', 'error');
                return;
            }

            const requestInfo = {
                method: 'POST',
                url: 'http://localhost:3000/api/v1/threads/chat',
                headers: {
                    'Content-Type': 'application/json',
                    'x-key': 'demo-api-key'
                },
                body: {
                    message: 'Este es mi segundo mensaje',
                    session_id: sessionId
                }
            };
            
            addResult('üì§ SEGUNDO MENSAJE simulado - Mensaje + session_id en body', 'success');
            addResult(`<pre>${JSON.stringify(requestInfo, null, 2)}</pre>`, 'info');
        }        // Verificar estado inicial
        addResult('‚úÖ P√°gina cargada correctamente', 'success');
        addResult('‚è≥ Cargando widget con session management actualizado...', 'info');
        checkSessionId();
    </script>

    <!-- Widget con session management actualizado -->
    <script src="dist/widget/geekway-chat-widget.min.js"></script>

    <script>
        addResult('üì° Widget cargado, verificando session management...', 'info');

        if (typeof window.GeekWayChat !== 'undefined') {
            addResult('‚úÖ GeekWayChat disponible!', 'success');

            try {
                const result = window.GeekWayChat.init({
                    apiKey: '54b71fbf7c0c22b54a08bfdfa91609a0ffd35ae81125f20e70eb7b2afddf97be',
                    apiBaseUrl: 'http://localhost:3000/api/v1',
                    theme: 'purple',
                    position: 'bottom-right',
                    welcomeMessage: '¬°Hola! üëã Soy GeekWay Chat v3.0.2. Ahora env√≠o el session_id correctamente en el BODY del request seg√∫n la documentaci√≥n API. ¬°Prueba enviando mensajes!'
                });

                addResult('‚úÖ Widget inicializado con session management v3.0.2', 'success');
                addResult('üîÑ CORREGIDO: Session ID se env√≠a en body seg√∫n documentaci√≥n', 'change');
                addResult('üì§ CORREGIDO: Headers solo contienen x-key', 'change');
                addResult('üí¨ Abre el chat y env√≠a mensajes para probar', 'info');

            } catch(e) {
                addResult(`‚ùå Error al inicializar: ${e.message}`, 'error');
            }
        } else {
            addResult('‚ùå GeekWayChat no disponible', 'error');
        }

        // Monitor para cambios en localStorage
        let lastSessionId = localStorage.getItem('session_id');
        setInterval(() => {
            const currentSessionId = localStorage.getItem('session_id');
            if (currentSessionId !== lastSessionId) {
                lastSessionId = currentSessionId;
                checkSessionId();
                if (currentSessionId) {
                    addResult(`üîÑ Session ID actualizado autom√°ticamente: ${currentSessionId}`, 'change');
                }
            }
        }, 1000);
    </script>
</body>
</html>
