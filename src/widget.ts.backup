import { createApplication } from '@angular/platform-browser';
import { createCustomElement } from '@angular/elements';
import { ChatBubbleComponent } from './app/chat-bubble.component';
import { appConfig } from './app/app.config';

// Interfaces para TypeScript
interface ChatConfig {
  apiKey: string;
  theme?: 'purple' | 'blue';
  position?: 'bottom-right' | 'bottom-left' | 'top-right' | 'top-left';
  welcomeMessage?: string;
}

// API Global para el widget - DISPONIBLE INMEDIATAMENTE
class GeekWayChat {
    private static instance: GeekWayChat | null = null;
    private widget: HTMLElement | null = null;

    static init(config: ChatConfig): GeekWayChat {
      // Remover instancia anterior si existe
      if (GeekWayChat.instance) {
        GeekWayChat.instance.destroy();
      }

      GeekWayChat.instance = new GeekWayChat();
      GeekWayChat.instance.createWidget(config);
      return GeekWayChat.instance;
    }

    private createWidget(config: ChatConfig): void {
      // Asegurarse de que no hay widgets duplicados
      this.destroy();

      // Esperar a que el custom element esté registrado
      setTimeout(() => {
        // Crear el elemento
        this.widget = document.createElement('geekway-chat-widget');

        // Configurar atributos
        this.widget.setAttribute('api-key', config.apiKey);

        if (config.theme) {
          this.widget.setAttribute('theme', config.theme);
        }

        if (config.position) {
          this.widget.setAttribute('position', config.position);
        }

        if (config.welcomeMessage) {
          this.widget.setAttribute('welcome-message', config.welcomeMessage);
        }

        // Agregar al DOM
        document.body.appendChild(this.widget);

        console.log('✅ GeekWay Chat Widget inicializado:', config);
      }, 100);
    }

    destroy(): void {
      const existingWidgets = document.querySelectorAll('geekway-chat-widget');
      existingWidgets.forEach(widget => {
        if (widget.parentNode) {
          widget.parentNode.removeChild(widget);
        }
      });
      this.widget = null;
    }

    show(): void {
      if (this.widget) {
        this.widget.style.display = 'block';
      }
    }

    hide(): void {
      if (this.widget) {
        this.widget.style.display = 'none';
      }
    }
  }

  // Exponer la API globalmente
  (window as any).GeekWayChat = GeekWayChat;

  console.log('🚀 GeekWay Chat Widget ready for integration!');

}).catch(err => {
  console.error('❌ Error inicializando GeekWay Chat Widget:', err);
});
