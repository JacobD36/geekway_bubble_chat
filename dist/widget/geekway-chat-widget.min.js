class GeekWayChat{constructor(){this.widget=null,this.isOpen=!1,this.messages=[],this.apiKey=null,this.apiBaseUrl="https://gogeekwayapi-production.up.railway.app/api/v1",this.isLoading=!1,this.sessionId=null}static init(n){return console.log("üöÄ GeekWayChat.init() - Vanilla JS version",n),GeekWayChat.instance&&GeekWayChat.instance.destroy(),GeekWayChat.instance=new GeekWayChat,GeekWayChat.instance.createWidget(n),GeekWayChat.instance}createWidget(n){n.theme;const e=n.position||"bottom-right",t=n.welcomeMessage||"¬°Hola! Soy el asistente de GeekWay. ¬øEn qu√© puedo ayudarte?";this.apiKey=n.apiKey,this.apiBaseUrl=n.apiBaseUrl||"https://gogeekwayapi-production.up.railway.app/api/v1",this.apiKey?(this.messages=[{id:1,text:t,sender:"bot",timestamp:new Date}],this.injectStyles(),this.widget=document.createElement("div"),this.widget.className=`geekway-chat-widget ${this.getPositionClass(e)}`,this.widget.innerHTML=`\n      <button class="chat-button">\n        <svg class="chat-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>\n        </svg>\n        <svg class="close-icon hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>\n        </svg>\n      </button>\n\n      <div class="chat-window hidden">\n        <div class="chat-header">\n          <h3>GeekWay Chat</h3>\n        </div>\n        <div class="chat-messages" id="chat-messages">\n          ${this.renderMessages()}\n        </div>\n        <div class="chat-input">\n          <input type="text" id="message-input" placeholder="Escribe aqu√≠ tu mensaje..." />\n          <button id="send-button">\n            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">\n              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>\n            </svg>\n          </button>\n        </div>\n      </div>\n    `,document.body.appendChild(this.widget),this.setupEvents(),console.log("‚úÖ GeekWay Chat Widget creado (Vanilla JS)",{position:e,class:this.getPositionClass(e)})):console.error("‚ùå GeekWay Chat: API Key es requerida")}getPositionClass(n){switch(n){case"bottom-left":return"position-bottom-left";case"top-right":return"position-top-right";case"top-left":return"position-top-left";default:return"position-bottom-right"}}renderMessages(){return this.messages.map(n=>`\n      <div class="message ${n.sender}">\n        <div class="message-avatar">\n          ${"bot"===n.sender?this.getBotIcon():this.getUserIcon()}\n        </div>\n        <div class="message-content">\n          <span class="message-text">${n.isHTML?n.text:this.escapeHtml(n.text)}</span>\n        </div>\n      </div>\n    `).join("")}escapeHtml(n){const e=document.createElement("div");return e.textContent=n,e.innerHTML}getBotIcon(){return'\n      <svg class="avatar-icon bot-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">\n        <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/>\n        <circle cx="9" cy="10" r="1.5"/>\n        <circle cx="15" cy="10" r="1.5"/>\n        <path d="M8 14c0 2.21 1.79 4 4 4s4-1.79 4-4H8z"/>\n      </svg>\n    '}getUserIcon(){return'\n      <svg class="avatar-icon user-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">\n        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>\n      </svg>\n    '}setupEvents(){if(!this.widget)return;const n=this.widget.querySelector(".chat-button"),e=this.widget.querySelector(".chat-window"),t=this.widget.querySelector("#message-input"),i=this.widget.querySelector("#send-button"),o=this.widget.querySelector(".chat-icon"),s=this.widget.querySelector(".close-icon");n.addEventListener("click",()=>{this.isOpen=!this.isOpen,this.isOpen?(e.classList.remove("hidden"),o.classList.add("hidden"),s.classList.remove("hidden"),setTimeout(()=>this.scrollToBottom(),100)):(e.classList.add("hidden"),o.classList.remove("hidden"),s.classList.add("hidden"))});const a=async()=>{const n=t.value.trim();if(n&&!this.isLoading){this.isLoading=!0,t.disabled=!0,i.disabled=!0,this.messages.push({id:Date.now(),text:n,sender:"user",timestamp:new Date}),t.value="",this.updateMessages(),this.scrollToBottom(),this.showTypingIndicator();try{const e=await this.callChatAPI(n);if(this.hideTypingIndicator(),!e||!e.data)throw new Error("Respuesta inv√°lida de la API");{let n="";if(!e.data.message)throw new Error("No se encontr√≥ mensaje en la respuesta");n=e.data.message,e.data.products&&e.data.products.length>0&&(n+=this.formatProductsHTML(e.data.products)),this.messages.push({id:Date.now(),text:n,sender:"bot",timestamp:new Date,isHTML:!0}),e.data.session_id&&(this.sessionId=e.data.session_id,console.log("üíæ Session ID guardado en memoria:",this.sessionId))}}catch(n){console.error("‚ùå Error al enviar mensaje:",n),this.hideTypingIndicator(),this.messages.push({id:Date.now(),text:"Lo siento, ha ocurrido un error. Por favor, int√©ntalo de nuevo.",sender:"bot",timestamp:new Date,isError:!0})}finally{this.isLoading=!1,t.disabled=!1,i.disabled=!1,t.focus(),this.updateMessages(),this.scrollToBottom()}}};i.addEventListener("click",a),t.addEventListener("keypress",n=>{"Enter"===n.key&&a()})}formatProductsHTML(n){if(console.log("üîç formatProductsHTML recibi√≥:",n),!n||0===n.length)return console.warn("‚ö†Ô∏è No hay productos para formatear"),"";let e='<div class="products-container">';return e+='<div class="products-header">',e+='<span class="results-icon">üìã</span>',e+='<span class="results-title">Resultados</span>',e+="</div>",e+='<div class="products-list">',n.forEach((n,t)=>{console.log(`üì¶ Procesando item ${t}:`,n),e+='<div class="product-card">';const i=[],o=[],s=[];Object.keys(n).forEach(e=>{const t=n[e],a=e.toLowerCase();console.log(`  üîë Campo: ${e} = ${t} (tipo: ${typeof t})`),null!=t&&""!==t?a.startsWith("url")?(console.log(`  üîó URL detectada: ${e}`),i.push({key:e,value:t})):a.startsWith("img")?(console.log(`  üñºÔ∏è Imagen detectada: ${e}`),o.push({key:e,value:t})):(console.log(`  üìù Campo regular: ${e}`),s.push({key:e,value:t})):console.log(`  ‚è≠Ô∏è Campo ${e} vac√≠o, saltando`)}),console.log("  ‚úÖ Clasificaci√≥n:",{urls:i.length,imgs:o.length,regular:s.length}),o.length>0&&(e+='<div class="item-image-container">',o.forEach(n=>{console.log(`  üé® Renderizando imagen: ${n.value}`),e+=`<img src="${this.escapeHtml(n.value)}" alt="Imagen" class="item-image" onerror="this.style.display='none'" />`}),e+="</div>"),s.length>0&&(e+='<div class="item-content">',s.forEach((n,t)=>{const i=0===t,o=this.escapeHtml(String(n.value));if(i)console.log(`  üìå T√≠tulo: ${o}`),e+=`<div class="item-title">${o}</div>`;else{const t=this.formatFieldName(n.key);console.log(`  üìã Info: ${t}: ${o}`),e+='<div class="item-field">',e+=`<span class="item-label">${t}:</span> `,e+=`<span class="item-value">${o}</span>`,e+="</div>"}}),e+="</div>"),i.length>0&&(e+='<div class="item-actions">',i.forEach(n=>{const t=this.formatFieldName(n.key)||"Ver m√°s";console.log(`  üîò Bot√≥n: ${t} -> ${n.value}`),e+=`<a href="${this.escapeHtml(n.value)}" target="_blank" rel="noopener noreferrer" class="item-link">`,e+='<svg class="link-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">',e+='<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>',e+="</svg>",e+=`<span>${t}</span>`,e+="</a>"}),e+="</div>"),e+="</div>"}),e+="</div>",e+="</div>",console.log("‚úÖ HTML generado (primeros 200 chars):",e.substring(0,200)+"..."),e}formatFieldName(n){let e=n.replace(/^(url_|img_)/i,"");return e=e.replace(/_/g," ").replace(/([A-Z])/g," $1"),e.split(" ").map(n=>n.charAt(0).toUpperCase()+n.slice(1).toLowerCase()).join(" ").trim()}async callChatAPI(n){const e=`${this.apiBaseUrl}/threads/chat`,t={message:n};this.sessionId&&(t.session_id=this.sessionId);const i={"Content-Type":"application/json","x-key":this.apiKey};console.log("üì° Enviando mensaje a API:",{url:e,body:t,headers:{...i,"x-key":"[OCULTA]"}});const o=await fetch(e,{method:"POST",headers:i,body:JSON.stringify(t)});if(!o.ok){const n=await o.text();throw new Error(`HTTP ${o.status}: ${n}`)}const s=await o.json();return console.log("‚úÖ Respuesta de API recibida:",s),s}showTypingIndicator(){this.hideTypingIndicator();const n={id:"typing-indicator",text:'<div class="typing-indicator"><span></span><span></span><span></span></div>',sender:"bot",timestamp:new Date,isTyping:!0,isHTML:!0};this.messages.push(n),this.updateMessages(),this.scrollToBottom()}hideTypingIndicator(){this.messages=this.messages.filter(n=>"typing-indicator"!==n.id),this.updateMessages()}updateMessages(){const n=this.widget?.querySelector("#chat-messages");n&&(n.innerHTML=this.renderMessages())}scrollToBottom(){const n=this.widget?.querySelector("#chat-messages");n&&(n.scrollTop=n.scrollHeight)}injectStyles(){if(document.getElementById("geekway-chat-styles"))return;const n=document.createElement("style");n.id="geekway-chat-styles",n.textContent='\n      .geekway-chat-widget * {\n        box-sizing: border-box;\n        margin: 0;\n        padding: 0;\n      }\n\n      .chat-button {\n        position: fixed;\n        width: 56px;\n        height: 56px;\n        background: #8b5cf6;\n        border: none;\n        border-radius: 50%;\n        box-shadow: 0 8px 24px rgba(139, 92, 246, 0.4), 0 4px 12px rgba(0, 0, 0, 0.3);\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        z-index: 9999;\n        transition: all 0.3s ease;\n      }\n\n      .chat-button:hover {\n        background: #7c3aed;\n        transform: scale(1.1);\n        box-shadow: 0 12px 32px rgba(139, 92, 246, 0.5), 0 6px 16px rgba(0, 0, 0, 0.4);\n      }\n\n      .chat-button svg {\n        width: 24px;\n        height: 24px;\n        color: white;\n      }\n\n      .chat-window {\n        position: fixed;\n        width: 384px;\n        height: 650px;\n        background: white;\n        border-radius: 16px;\n        box-shadow: 0 10px 25px rgba(0,0,0,0.2);\n        z-index: 9998;\n        display: flex;\n        flex-direction: column;\n        overflow: hidden;\n        transition: all 0.3s ease;\n        animation: slideUp 0.3s ease-out;\n      }\n\n      @keyframes slideUp {\n        from {\n          opacity: 0;\n          transform: translateY(20px) scale(0.95);\n        }\n        to {\n          opacity: 1;\n          transform: translateY(0) scale(1);\n        }\n      }\n\n      .chat-window.hidden {\n        display: none;\n      }\n\n      /* POSICIONAMIENTO BOTTOM-RIGHT (por defecto) */\n      .geekway-chat-widget .position-bottom-right .chat-button,\n      .geekway-chat-widget.position-bottom-right .chat-button {\n        bottom: 24px;\n        right: 24px;\n      }\n\n      .geekway-chat-widget .position-bottom-right .chat-window,\n      .geekway-chat-widget.position-bottom-right .chat-window {\n        bottom: 96px;\n        right: 24px;\n      }\n\n      /* POSICIONAMIENTO BOTTOM-LEFT */\n      .geekway-chat-widget .position-bottom-left .chat-button,\n      .geekway-chat-widget.position-bottom-left .chat-button {\n        bottom: 24px;\n        left: 24px;\n      }\n\n      .geekway-chat-widget .position-bottom-left .chat-window,\n      .geekway-chat-widget.position-bottom-left .chat-window {\n        bottom: 96px;\n        left: 24px;\n      }\n\n      /* POSICIONAMIENTO TOP-RIGHT */\n      .geekway-chat-widget .position-top-right .chat-button,\n      .geekway-chat-widget.position-top-right .chat-button {\n        top: 24px;\n        right: 24px;\n      }\n\n      .geekway-chat-widget .position-top-right .chat-window,\n      .geekway-chat-widget.position-top-right .chat-window {\n        top: 96px;\n        right: 24px;\n      }\n\n      /* POSICIONAMIENTO TOP-LEFT */\n      .geekway-chat-widget .position-top-left .chat-button,\n      .geekway-chat-widget.position-top-left .chat-button {\n        top: 24px;\n        left: 24px;\n      }\n\n      .geekway-chat-widget .position-top-left .chat-window,\n      .geekway-chat-widget.position-top-left .chat-window {\n        top: 96px;\n        left: 24px;\n      }\n\n      .chat-header {\n        background: linear-gradient(135deg, #8b5cf6, #7c3aed);\n        color: white;\n        padding: 16px;\n        text-align: center;\n      }\n\n      .chat-header h3 {\n        font-size: 18px;\n        font-weight: bold;\n        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;\n      }\n\n      .chat-messages {\n        flex: 1;\n        padding: 16px;\n        overflow-y: auto;\n        background: #f9fafb;\n        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;\n        display: flex;\n        flex-direction: column;\n      }\n\n      .message {\n        margin-bottom: 16px;\n        display: flex;\n        align-items: flex-end;\n        gap: 8px;\n        width: 100%;\n      }\n\n      .message.bot {\n        justify-content: flex-start;\n        flex-direction: row;\n      }\n\n      .message.user {\n        justify-content: flex-end;\n        flex-direction: row-reverse;\n        margin-left: auto;\n        text-align: right;\n      }\n\n      .message-avatar {\n        width: 32px;\n        height: 32px;\n        border-radius: 50%;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        flex-shrink: 0;\n        margin-bottom: 2px;\n      }\n\n      .message.bot .message-avatar {\n        background: #8b5cf6;\n        color: white;\n        order: 1;\n      }\n\n      .message.user .message-avatar {\n        background: #3b82f6;\n        color: white;\n        order: 1;\n      }\n\n      .avatar-icon {\n        width: 18px;\n        height: 18px;\n      }\n\n      .bot-icon {\n        color: white;\n      }\n\n      .user-icon {\n        color: white;\n      }\n\n      .message-content {\n        max-width: calc(100% - 40px);\n        padding: 12px 16px;\n        border-radius: 18px;\n        font-size: 14px;\n        line-height: 1.4;\n        order: 2;\n      }\n\n      .message.bot .message-content {\n        background: #e5e7eb;\n        color: #1f2937;\n        border-bottom-left-radius: 4px;\n        margin-left: 0;\n        margin-right: auto;\n        border: 1px solid #d1d5db;\n      }\n\n      .message.user .message-content {\n        background: #3b82f6;\n        color: white;\n        border-bottom-right-radius: 4px;\n        margin-right: 0;\n        margin-left: auto;\n        text-align: left;\n      }\n\n      .chat-input {\n        display: flex;\n        padding: 16px;\n        background: white;\n        border-top: 1px solid #e5e7eb;\n        gap: 8px;\n      }\n\n      #message-input {\n        flex: 1;\n        padding: 12px 16px;\n        border: 1px solid #d1d5db;\n        border-radius: 24px;\n        outline: none;\n        font-size: 14px;\n        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;\n      }\n\n      #message-input:focus {\n        border-color: #8b5cf6;\n        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);\n      }\n\n      #send-button {\n        width: 40px;\n        height: 40px;\n        background: #8b5cf6;\n        border: none;\n        border-radius: 50%;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        cursor: pointer;\n        transition: background 0.2s ease;\n      }\n\n      #send-button:hover {\n        background: #7c3aed;\n      }\n\n      #send-button svg {\n        width: 20px;\n        height: 20px;\n        color: white;\n      }\n\n      #send-button:disabled {\n        background: #9ca3af;\n        cursor: not-allowed;\n      }\n\n      #message-input:disabled {\n        background: #f3f4f6;\n        cursor: not-allowed;\n      }\n\n      /* Indicador de escritura */\n      .typing-indicator {\n        display: flex;\n        align-items: center;\n        gap: 4px;\n        padding: 8px 0;\n      }\n\n      .typing-indicator span {\n        width: 8px;\n        height: 8px;\n        background: #9ca3af;\n        border-radius: 50%;\n        animation: typing 1.5s infinite;\n      }\n\n      .typing-indicator span:nth-child(2) {\n        animation-delay: 0.3s;\n      }\n\n      .typing-indicator span:nth-child(3) {\n        animation-delay: 0.6s;\n      }\n\n      @keyframes typing {\n        0%, 60%, 100% {\n          transform: translateY(0);\n          opacity: 0.4;\n        }\n        30% {\n          transform: translateY(-10px);\n          opacity: 1;\n        }\n      }\n\n      .hidden {\n        display: none !important;\n      }\n\n      /* Estilos para contenido din√°mico - Sistema adaptable */\n      .products-container {\n        margin-top: 12px;\n        background: #ffffff;\n        border-radius: 12px;\n        overflow: hidden;\n        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);\n      }\n\n      .products-header {\n        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);\n        padding: 10px 14px;\n        display: flex;\n        align-items: center;\n        gap: 8px;\n      }\n\n      .results-icon {\n        font-size: 16px;\n      }\n\n      .results-title {\n        color: white;\n        font-size: 13px;\n        font-weight: 600;\n        letter-spacing: 0.3px;\n      }\n\n      .products-list {\n        padding: 0;\n        margin: 0;\n      }\n\n      /* Tarjeta individual de item */\n      .product-card {\n        padding: 14px;\n        border-bottom: 1px solid #f1f5f9;\n        transition: background-color 0.2s ease;\n      }\n\n      .product-card:last-child {\n        border-bottom: none;\n      }\n\n      .product-card:hover {\n        background-color: #f8fafc;\n      }\n\n      /* Contenedor de imagen */\n      .item-image-container {\n        margin-bottom: 12px;\n        border-radius: 8px;\n        overflow: hidden;\n        background: #f8fafc;\n        display: flex;\n        justify-content: center;\n        align-items: center;\n        max-height: 180px;\n      }\n\n      .item-image {\n        width: 100%;\n        height: auto;\n        max-height: 180px;\n        object-fit: cover;\n        display: block;\n      }\n\n      /* Contenido del item */\n      .item-content {\n        display: flex;\n        flex-direction: column;\n        gap: 6px;\n      }\n\n      /* T√≠tulo principal (primer campo) */\n      .item-title {\n        font-size: 15px;\n        font-weight: 600;\n        color: #1e293b;\n        margin-bottom: 4px;\n        line-height: 1.4;\n      }\n\n      /* Campo de informaci√≥n */\n      .item-field {\n        font-size: 13px;\n        line-height: 1.5;\n        color: #475569;\n      }\n\n      .item-label {\n        font-weight: 500;\n        color: #64748b;\n      }\n\n      .item-value {\n        color: #1e293b;\n      }\n\n      /* Acciones (botones de URL) */\n      .item-actions {\n        margin-top: 10px;\n        display: flex;\n        flex-wrap: wrap;\n        gap: 8px;\n      }\n\n      .item-link {\n        display: inline-flex;\n        align-items: center;\n        gap: 6px;\n        padding: 6px 12px;\n        background: transparent;\n        color: #8b5cf6;\n        text-decoration: none;\n        border: 1px solid #e9d5ff;\n        border-radius: 6px;\n        font-size: 12px;\n        font-weight: 500;\n        transition: all 0.2s ease;\n      }\n\n      .item-link:hover {\n        background: #f3e8ff;\n        border-color: #c4b5fd;\n        transform: translateY(-1px);\n      }\n\n      .link-icon {\n        width: 14px;\n        height: 14px;\n        stroke-width: 2;\n      }\n\n      @media (max-width: 640px) {\n        .chat-window {\n          width: calc(100vw - 32px);\n          height: 80vh;\n          right: 16px !important;\n          left: 16px !important;\n          bottom: 96px !important;\n        }\n      }\n    ',document.head.appendChild(n)}destroy(){this.widget&&(this.widget.remove(),this.widget=null);const n=document.getElementById("geekway-chat-styles");n&&n.remove()}show(){this.widget&&(this.widget.style.display="block")}hide(){this.widget&&(this.widget.style.display="none")}}GeekWayChat.instance=null,window.GeekWayChat=GeekWayChat,console.log("üåç GeekWayChat (Vanilla JS) disponible globalmente"),console.log("‚úÖ Sin dependencias - Compatibilidad universal");