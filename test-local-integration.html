<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Test Local Chat Widget v3.0.4</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin: 0 0 10px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
            margin: 0;
        }

        .demo-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin: 20px 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .demo-section h2 {
            margin: 0 0 20px 0;
            font-size: 1.5rem;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }

        .btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .btn.primary {
            background: #8b5cf6;
            border-color: #7c3aed;
        }

        .btn.primary:hover {
            background: #7c3aed;
        }

        .status {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .status.success {
            border-left: 4px solid #10b981;
        }

        .status.error {
            border-left: 4px solid #ef4444;
        }

        .status.info {
            border-left: 4px solid #3b82f6;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .feature-card h3 {
            margin: 0 0 10px 0;
            font-size: 1.1rem;
        }

        .feature-card p {
            margin: 0;
            opacity: 0.8;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .controls {
                flex-direction: column;
            }

            .btn {
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ GeekWay Chat Widget</h1>
            <p>Test Local v3.0.4 - Soporte para Productos API</p>
        </div>

        <div class="demo-section">
            <h2>‚ö° Control del Widget</h2>
            <div class="controls">
                <button class="btn primary" onclick="initWidget()">üéØ Inicializar Widget</button>
                <button class="btn" onclick="testProducts()">üì¶ Test Productos</button>
                <button class="btn" onclick="testMessage()">üí¨ Test Mensaje</button>
                <button class="btn" onclick="checkStatus()">üîç Estado Widget</button>
                <button class="btn" onclick="clearChat()">üóëÔ∏è Limpiar Chat</button>
            </div>

            <div id="widget-status" class="status info">
                ‚è≥ Widget no inicializado. Haz clic en "Inicializar Widget" para comenzar.
            </div>
        </div>

        <div class="demo-section">
            <h2>üß™ Pruebas de API</h2>
            <div class="controls">
                <button class="btn" onclick="simulateProductResponse()">üõçÔ∏è Simular Respuesta con Productos</button>
                <button class="btn" onclick="simulateEmptyResponse()">üì≠ Simular Respuesta Vac√≠a</button>
                <button class="btn" onclick="simulateError()">‚ùå Simular Error</button>
                <button class="btn" onclick="testSessionId()">üîê Test Session ID</button>
            </div>
        </div>

        <div class="feature-grid">
            <div class="feature-card">
                <h3>üéØ Caracter√≠sticas v3.0.4</h3>
                <p>‚Ä¢ Soporte para productos API<br>
                ‚Ä¢ Gesti√≥n de sesi√≥n en memoria<br>
                ‚Ä¢ Dise√±o est√©tico profesional<br>
                ‚Ä¢ Enlaces de productos funcionales</p>
            </div>

            <div class="feature-card">
                <h3>üîß Estructura API</h3>
                <p>‚Ä¢ data.message (mensaje del asistente)<br>
                ‚Ä¢ data.products[] (lista de productos)<br>
                ‚Ä¢ data.session_id (gesti√≥n de sesi√≥n)<br>
                ‚Ä¢ HTML rendering seguro</p>
            </div>

            <div class="feature-card">
                <h3>üì± Compatibilidad</h3>
                <p>‚Ä¢ Cero localStorage<br>
                ‚Ä¢ Responsive design<br>
                ‚Ä¢ XSS protection<br>
                ‚Ä¢ Target blank para enlaces</p>
            </div>
        </div>
    </div>

    <!-- Widget Script Local -->
    <script src="dist/widget/geekway-chat-widget.min.js"></script>

    <script>
        let widgetInstance = null;
        const statusDiv = document.getElementById('widget-status');

        function updateStatus(message, type = 'info') {
            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = message;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function initWidget() {
            try {
                if (widgetInstance) {
                    widgetInstance.destroy();
                    updateStatus('üîÑ Widget anterior destruido, reiniciando...', 'info');
                }

                // Configuraci√≥n del widget
                const config = {
                    apiKey: 'test-api-key-local-demo',
                    apiBaseUrl: 'https://api-demo.geekway.com/api/v1',
                    assistantName: 'GeekWay Assistant',
                    welcomeMessage: '¬°Hola! üëã Soy tu asistente GeekWay. Puedo ayudarte a encontrar productos y responder tus preguntas. ¬øEn qu√© puedo ayudarte hoy?',
                    theme: 'purple',
                    position: 'bottom-right'
                };

                // Verificar que la clase existe
                if (typeof GeekwayChatWidget === 'undefined') {
                    throw new Error('GeekwayChatWidget no est√° definido. Verifica que el script se haya cargado correctamente.');
                }

                // Inicializar widget
                widgetInstance = new GeekwayChatWidget(config);

                updateStatus('‚úÖ Widget inicializado exitosamente. Mira la esquina inferior derecha.', 'success');

                // Log del estado
                console.log('Widget configurado:', config);
                console.log('Instancia del widget:', widgetInstance);

            } catch (error) {
                updateStatus(`‚ùå Error al inicializar widget: ${error.message}`, 'error');
                console.error('Error completo:', error);
            }
        }

        function testProducts() {
            if (!widgetInstance) {
                updateStatus('‚ö†Ô∏è Primero inicializa el widget', 'error');
                return;
            }

            updateStatus('üì¶ Simulando respuesta con productos...', 'info');

            const mockResponse = {
                code: 200,
                message: "Chat procesado exitosamente",
                status: "OK",
                data: {
                    session_id: "local-test-session-" + Date.now(),
                    message: "Aqu√≠ tienes algunos productos que podr√≠an interesarte:",
                    products: [
                        {
                            codigo_producto: "P001",
                            nombre_producto: "MacBook Pro M3",
                            descripcion: "Laptop profesional con chip M3, 16GB RAM y 512GB SSD. Perfecta para desarrollo y dise√±o.",
                            categoria: "Laptops",
                            precio: "3,999 USD",
                            color: "Space Gray",
                            proveedor: "Apple",
                            estado_producto: "Nuevo",
                            url_articulo: "https://www.apple.com/macbook-pro/"
                        },
                        {
                            codigo_producto: "P002",
                            nombre_producto: "Samsung Monitor 4K",
                            descripcion: "Monitor Ultra HD de 27 pulgadas con tecnolog√≠a HDR y conectividad USB-C.",
                            categoria: "Monitores",
                            precio: "899 USD",
                            color: "Negro",
                            proveedor: "Samsung",
                            estado_producto: "Nuevo",
                            url_articulo: "https://www.samsung.com/monitors/"
                        }
                    ]
                }
            };

            simulateAPICall(mockResponse);
        }

        function testMessage() {
            if (!widgetInstance) {
                updateStatus('‚ö†Ô∏è Primero inicializa el widget', 'error');
                return;
            }

            updateStatus('üí¨ Simulando mensaje simple...', 'info');

            const mockResponse = {
                code: 200,
                message: "Chat procesado exitosamente",
                status: "OK",
                data: {
                    session_id: "local-test-session-" + Date.now(),
                    message: "¬°Hola! üëã Soy tu asistente GeekWay. Estoy aqu√≠ para ayudarte con cualquier pregunta que tengas. Puedo buscar productos, proporcionar informaci√≥n y mucho m√°s. ¬øEn qu√© puedo ayudarte hoy?",
                    products: []
                }
            };

            simulateAPICall(mockResponse);
        }

        function simulateProductResponse() {
            testProducts();
        }

        function simulateEmptyResponse() {
            if (!widgetInstance) {
                updateStatus('‚ö†Ô∏è Primero inicializa el widget', 'error');
                return;
            }

            updateStatus('üì≠ Simulando respuesta vac√≠a...', 'info');

            const mockResponse = {
                code: 200,
                message: "Chat procesado exitosamente",
                status: "OK",
                data: {
                    session_id: "local-test-session-" + Date.now(),
                    message: "No encontr√© productos que coincidan con tu b√∫squeda. ¬øPuedes ser m√°s espec√≠fico o probar con otros t√©rminos?",
                    products: []
                }
            };

            simulateAPICall(mockResponse);
        }

        function simulateError() {
            if (!widgetInstance) {
                updateStatus('‚ö†Ô∏è Primero inicializa el widget', 'error');
                return;
            }

            updateStatus('‚ùå Simulando error de API...', 'error');

            // Simular un mensaje de error en el chat
            widgetInstance.messages.push({
                id: Date.now(),
                text: '‚ùå Error: No se pudo conectar con el servidor. Por favor, int√©ntalo de nuevo m√°s tarde.',
                sender: 'bot',
                timestamp: new Date()
            });

            widgetInstance.updateMessages();
            widgetInstance.scrollToBottom();
        }

        function testSessionId() {
            if (!widgetInstance) {
                updateStatus('‚ö†Ô∏è Primero inicializa el widget', 'error');
                return;
            }

            const currentSessionId = widgetInstance.sessionId;
            updateStatus(`üîê Session ID actual: ${currentSessionId || 'null (primera vez)'}`, 'info');

            console.log('Estado completo del widget:', {
                sessionId: widgetInstance.sessionId,
                messagesCount: widgetInstance.messages.length,
                isOpen: widgetInstance.isOpen,
                apiBaseUrl: widgetInstance.apiBaseUrl
            });
        }

        function checkStatus() {
            if (!widgetInstance) {
                updateStatus('‚ùå Widget no inicializado', 'error');
                return;
            }

            const status = {
                isInitialized: !!widgetInstance,
                isOpen: widgetInstance.isOpen,
                messagesCount: widgetInstance.messages.length,
                sessionId: widgetInstance.sessionId,
                apiBaseUrl: widgetInstance.apiBaseUrl
            };

            updateStatus(`‚úÖ Widget activo: ${status.messagesCount} mensajes, Session: ${status.sessionId || 'pendiente'}`, 'success');
            console.log('Estado detallado:', status);
        }

        function clearChat() {
            if (!widgetInstance) {
                updateStatus('‚ö†Ô∏è Primero inicializa el widget', 'error');
                return;
            }

            widgetInstance.messages = [];
            widgetInstance.sessionId = null;
            widgetInstance.updateMessages();

            updateStatus('üóëÔ∏è Chat limpiado y session_id reiniciado', 'info');
        }

        function simulateAPICall(mockResponse) {
            // Agregar mensaje de usuario primero
            widgetInstance.messages.push({
                id: Date.now() - 100,
                text: 'Mensaje de prueba del usuario',
                sender: 'user',
                timestamp: new Date()
            });

            // Procesar respuesta simulada
            if (mockResponse.data && mockResponse.data.message) {
                let botResponse = mockResponse.data.message;

                // Agregar productos si existen
                if (mockResponse.data.products && mockResponse.data.products.length > 0) {
                    botResponse += widgetInstance.formatProductsHTML(mockResponse.data.products);
                }

                widgetInstance.messages.push({
                    id: Date.now(),
                    text: botResponse,
                    sender: 'bot',
                    timestamp: new Date(),
                    isHTML: true
                });

                // Actualizar session_id
                if (mockResponse.data.session_id) {
                    widgetInstance.sessionId = mockResponse.data.session_id;
                }
            }

            // Actualizar interfaz
            widgetInstance.updateMessages();
            widgetInstance.scrollToBottom();

            updateStatus('‚úÖ Respuesta simulada procesada exitosamente', 'success');
        }

        // Inicializaci√≥n autom√°tica
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus('üì± P√°gina cargada. Listo para inicializar el widget.', 'info');

            // Auto-inicializar despu√©s de 1 segundo
            setTimeout(() => {
                initWidget();
            }, 1000);
        });

        // Detectar errores de carga de script
        window.addEventListener('error', function(e) {
            if (e.filename && e.filename.includes('geekway-chat-widget')) {
                updateStatus('‚ùå Error al cargar el script del widget. Verifica que el archivo existe.', 'error');
            }
        });
    </script>
</body>
</html>
